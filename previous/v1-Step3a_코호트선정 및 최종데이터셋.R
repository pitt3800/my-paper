# =============================================================================
# Step 3a: CT ë°ì´í„° ì¤€ë¹„ ë° ì™¸ë¶€ ë¶„ì„ìš© ë‚´ë³´ë‚´ê¸°
# =============================================================================
# ì—°êµ¬: 85ì„¸ ì´ìƒ ë°œì—´ í™˜ì CT ì§„ë‹¨ ê°€ì¹˜ ì—°êµ¬
# ëª©ì : CT ì†Œê²¬ ë°ì´í„° ë‚´ë³´ë‚´ê¸° â†’ ì™¸ë¶€ ë¶„ì„ â†’ ì¬ë¶ˆëŸ¬ì˜¤ê¸° ì¤€ë¹„
# ì˜ˆìƒ ì†Œìš”: 2-3ë¶„
# =============================================================================

#------------------------------------------------------------------------------
# 0. í™˜ê²½ ì„¤ì •
#------------------------------------------------------------------------------
library(tidyverse)
library(readxl)

setwd("/Users/youjinlee/Library/Mobile Documents/com~apple~CloudDocs/My R/Fever c claude")

cat("\n")
cat("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
cat("  Step 3a: CT ë°ì´í„° ì¤€ë¹„ ë° ì™¸ë¶€ ë¶„ì„                      \n")
cat("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")

# Part 2 ê²°ê³¼ë¬¼ ë¡œë“œ
cat("=== Part 2 ê²°ê³¼ë¬¼ ë¡œë“œ ===\n")
base_dedup <- readRDS("cleaned_data/part2_base_typed.rds")
ct_summary_dedup <- readRDS("cleaned_data/part2_ct_summary.rds")

cat(sprintf("âœ“ Base: %dëª…\n", nrow(base_dedup)))
cat(sprintf("âœ“ CT Summary: %dê±´\n\n", nrow(ct_summary_dedup)))

#------------------------------------------------------------------------------
# 1. CT ë°ì´í„° ë‚´ë³´ë‚´ê¸° (ì™¸ë¶€ ë¶„ì„ìš©)
#------------------------------------------------------------------------------
cat("=== STEP 1: CT ë°ì´í„° ë‚´ë³´ë‚´ê¸° ===\n")

# í˜„ì¬ CT summary êµ¬ì¡° í™•ì¸
cat("í˜„ì¬ CT Summary ì—´ êµ¬ì¡°:\n")
cat(paste(" -", names(ct_summary_dedup), collapse = "\n"))
cat("\n\n")

# ì™¸ë¶€ ë¶„ì„ìš© í…œí”Œë¦¿ ìƒì„± (ê¸°ì¡´ ë°ì´í„° + ë¹ˆ ì—´ ì¶”ê°€)
ct_for_analysis <- ct_summary_dedup %>%
  mutate(
    # ìƒˆë¡œ ì¶”ê°€í•  ì—´ë“¤ (ë¹ˆ ê°’ìœ¼ë¡œ ì´ˆê¸°í™”)
    fever_focus = NA_integer_,        # 1 = positive, 0 = negative
    disease_1 = NA_character_,        # ì£¼ìš” ì§ˆí™˜ 1
    disease_2 = NA_character_,        # ì£¼ìš” ì§ˆí™˜ 2  
    disease_3 = NA_character_         # ì£¼ìš” ì§ˆí™˜ 3
  ) %>%
  # ì—´ ìˆœì„œ ì¬ë°°ì¹˜ (ë¶„ì„í•˜ê¸° í¸í•˜ê²Œ)
  select(patient_id, visit_date, n_ct_scans, ct_any_positive, 
         ct_findings_combined, fever_focus, disease_1, disease_2, disease_3)

# CSV ë‚´ë³´ë‚´ê¸° (UTF-8 with BOM for Excel compatibility)
write_excel_csv(ct_for_analysis, "ct_for_external_analysis.csv")

cat("âœ… CT ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!\n")
cat("   íŒŒì¼ëª…: ct_for_external_analysis.csv\n")
cat(sprintf("   ì´ %dê±´ì˜ CT ê¸°ë¡\n\n", nrow(ct_for_analysis)))

#------------------------------------------------------------------------------
# 2. ì™¸ë¶€ ë¶„ì„ ê°€ì´ë“œ ìƒì„±
#------------------------------------------------------------------------------
cat("=== STEP 2: ì™¸ë¶€ ë¶„ì„ ê°€ì´ë“œ ìƒì„± ===\n")

# ë¶„ì„ ê°€ì´ë“œ í…ìŠ¤íŠ¸ ìƒì„±
analysis_guide <- c(
  "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
  "  CT ì†Œê²¬ ì™¸ë¶€ ë¶„ì„ ê°€ì´ë“œ",
  "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
  "",
  "ğŸ“ íŒŒì¼: ct_for_external_analysis.csv",
  "",
  "ğŸ¯ ë¶„ì„ ëª©í‘œ:",
  "   ê° í™˜ìì˜ CT ì†Œê²¬(ct_findings_combined)ì„ ê²€í† í•˜ê³ ",
  "   ì•„ë˜ 4ê°œ ì—´ì„ ì±„ì›Œì£¼ì„¸ìš”.",
  "",
  "ğŸ“ ì±„ì›Œì•¼ í•  ì—´:",
  "",
  "1. fever_focus (í•„ìˆ˜)",
  "   - CTì—ì„œ ë°œì—´ì˜ ì›ì¸ì´ ë  ìˆ˜ ìˆëŠ” positive findingì´ ìˆìœ¼ë©´: 1",
  "   - ì •ìƒì´ê±°ë‚˜ ë°œì—´ê³¼ ë¬´ê´€í•œ ì†Œê²¬ë§Œ ìˆìœ¼ë©´: 0",
  "   ",
  "   ì˜ˆì‹œ:",
  "   - Pneumonia â†’ 1",
  "   - UTI, pyelonephritis â†’ 1",
  "   - Intra-abdominal infection â†’ 1",
  "   - No acute finding â†’ 0",
  "   - Old lacunar infarction (ë°œì—´ ë¬´ê´€) â†’ 0",
  "",
  "2. disease_1 (ì£¼ìš” ì§ˆí™˜, í•„ìˆ˜)",
  "   - CTì—ì„œ ë°œê²¬ëœ ê°€ì¥ ì¤‘ìš”í•œ/ì£¼ëœ ì§ˆí™˜ëª…",
  "   - ì—†ìœ¼ë©´ ë¹„ì›Œë‘ê¸°",
  "   ",
  "   ì˜ˆì‹œ:",
  "   - Pneumonia",
  "   - Urinary tract infection",
  "   - Acute cholecystitis",
  "   - Colitis",
  "",
  "3. disease_2 (ë¶€ìˆ˜ ì§ˆí™˜, ì„ íƒ)",
  "   - ë‘ ë²ˆì§¸ë¡œ ì¤‘ìš”í•œ ì§ˆí™˜",
  "   - ì—†ìœ¼ë©´ ë¹„ì›Œë‘ê¸°",
  "",
  "4. disease_3 (ë¶€ìˆ˜ ì§ˆí™˜, ì„ íƒ)",
  "   - ì„¸ ë²ˆì§¸ ì§ˆí™˜",
  "   - ì—†ìœ¼ë©´ ë¹„ì›Œë‘ê¸°",
  "",
  "âš ï¸ ì£¼ì˜ì‚¬í•­:",
  "   1. patient_idì™€ visit_dateëŠ” ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”!",
  "   2. ct_findings_combinedë„ ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”!",
  "   3. ì—´ ì´ë¦„(fever_focus, disease_1 ë“±)ë„ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ì„¸ìš”!",
  "   4. ëª¨ë“  í™˜ìì˜ fever_focusì™€ disease_1ì€ ë°˜ë“œì‹œ ì±„ì›Œì£¼ì„¸ìš”!",
  "",
  "ğŸ’¾ ì™„ë£Œ í›„:",
  "   1. íŒŒì¼ëª…ì„ 'ct_analyzed.csv'ë¡œ ì €ì¥",
  "   2. ê°™ì€ í´ë”ì— ì €ì¥",
  "   3. Rë¡œ ëŒì•„ì™€ì„œ Step 3b ì‹¤í–‰",
  "",
  "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
)

# ê°€ì´ë“œ íŒŒì¼ë¡œ ì €ì¥
writeLines(analysis_guide, "CT_ë¶„ì„ê°€ì´ë“œ.txt", useBytes = TRUE)

cat("âœ… ë¶„ì„ ê°€ì´ë“œ ìƒì„± ì™„ë£Œ!\n")
cat("   íŒŒì¼ëª…: CT_ë¶„ì„ê°€ì´ë“œ.txt\n\n")

#------------------------------------------------------------------------------
# 3. ìƒ˜í”Œ ë°ì´í„° í™•ì¸ (ì°¸ê³ ìš©)
#------------------------------------------------------------------------------
cat("=== STEP 3: CT ì†Œê²¬ ìƒ˜í”Œ í™•ì¸ ===\n")

# CT ì†Œê²¬ ìƒ˜í”Œ ì¶œë ¥ (ì²˜ìŒ 5ê±´)
sample_ct <- ct_for_analysis %>%
  select(patient_id, ct_findings_combined, fever_focus, disease_1) %>%
  head(5)

cat("CT ì†Œê²¬ ìƒ˜í”Œ (ì²˜ìŒ 5ê±´):\n\n")
print(sample_ct, n = 5, width = Inf)
cat("\n")

# ì „ì²´ í†µê³„
cat("ğŸ“Š CT ë°ì´í„° ìš”ì•½:\n")
cat(sprintf("   â€¢ ì´ í™˜ì ìˆ˜: %dëª…\n", n_distinct(ct_for_analysis$patient_id)))
cat(sprintf("   â€¢ ì´ CT ê¸°ë¡: %dê±´\n", nrow(ct_for_analysis)))
cat(sprintf("   â€¢ ê¸°ì¡´ CT positive: %dê±´ (%.1f%%)\n",
            sum(ct_for_analysis$ct_any_positive == 1, na.rm = TRUE),
            sum(ct_for_analysis$ct_any_positive == 1, na.rm = TRUE) / nrow(ct_for_analysis) * 100))
cat("\n")

#------------------------------------------------------------------------------
# 4. ë°ì´í„° í’ˆì§ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸
#------------------------------------------------------------------------------
cat("=== STEP 4: ë°ì´í„° í’ˆì§ˆ ì²´í¬ ===\n")

# ì¤‘ë³µ í™•ì¸
n_duplicates <- ct_for_analysis %>%
  count(patient_id, visit_date) %>%
  filter(n > 1) %>%
  nrow()

cat(sprintf("âœ“ ì¤‘ë³µ ê¸°ë¡: %dê±´\n", n_duplicates))

# ê²°ì¸¡ê°’ í™•ì¸
missing_findings <- sum(is.na(ct_for_analysis$ct_findings_combined) | 
                          ct_for_analysis$ct_findings_combined == "")
cat(sprintf("âœ“ CT ì†Œê²¬ ê²°ì¸¡: %dê±´\n", missing_findings))

# í™˜ì ID í™•ì¸
cat(sprintf("âœ“ í™˜ì ID ë²”ìœ„: %s ~ %s\n", 
            min(ct_for_analysis$patient_id), 
            max(ct_for_analysis$patient_id)))
cat("\n")

#------------------------------------------------------------------------------
# 5. ì™„ë£Œ í™•ì¸
#------------------------------------------------------------------------------
cat("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
cat("  Step 3a ì™„ë£Œ                                               \n")
cat("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")

cat("âœ… ì™„ë£Œëœ ì‘ì—…:\n")
cat("   1. âœ“ CT ë°ì´í„° ë‚´ë³´ë‚´ê¸° (ct_for_external_analysis.csv)\n")
cat("   2. âœ“ ì™¸ë¶€ ë¶„ì„ ê°€ì´ë“œ ìƒì„± (CT_ë¶„ì„ê°€ì´ë“œ.txt)\n")
cat("   3. âœ“ ìƒ˜í”Œ ë°ì´í„° í™•ì¸\n")
cat("   4. âœ“ ë°ì´í„° í’ˆì§ˆ ì²´í¬\n\n")

cat("ğŸ“ ìƒì„±ëœ íŒŒì¼:\n")
cat("   â€¢ ct_for_external_analysis.csv - ì™¸ë¶€ ë¶„ì„ìš© ë°ì´í„°\n")
cat("   â€¢ CT_ë¶„ì„ê°€ì´ë“œ.txt - ë¶„ì„ ê°€ì´ë“œ\n\n")

cat("ğŸ”„ ë‹¤ìŒ ë‹¨ê³„:\n")
cat("   1. Excelì´ë‚˜ ë‹¤ë¥¸ ë„êµ¬ë¡œ ct_for_external_analysis.csv ì—´ê¸°\n")
cat("   2. CT_ë¶„ì„ê°€ì´ë“œ.txt ì°¸ê³ í•˜ì—¬ ë°ì´í„° ë¶„ì„\n")
cat("   3. fever_focus, disease_1, disease_2, disease_3 ì—´ ì±„ìš°ê¸°\n")
cat("   4. 'ct_analyzed.csv'ë¡œ ì €ì¥ (ê°™ì€ í´ë”)\n")
cat("   5. Step 3b ì‹¤í–‰\n\n")

cat("âš ï¸  ì¤‘ìš” ì•ˆë‚´:\n")
cat("   â€¢ ì™¸ë¶€ ë¶„ì„ ì™„ë£Œ ì „ê¹Œì§€ Step 3bë¥¼ ì‹¤í–‰í•˜ì§€ ë§ˆì„¸ìš”!\n")
cat("   â€¢ íŒŒì¼ëª…ê³¼ ì—´ ì´ë¦„ì„ ì •í™•íˆ ì§€ì¼œì£¼ì„¸ìš”!\n")
cat("   â€¢ patient_idì™€ visit_dateëŠ” ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”!\n\n")

#==============================================================================
# ë‹¤ìŒ ë‹¨ê³„ (Step 3b)
#==============================================================================
# Step 3bì—ì„œ ìˆ˜í–‰í•  ì‘ì—…:
# 
# 1. ì™¸ë¶€ì—ì„œ ë¶„ì„ ì™„ë£Œëœ 'ct_analyzed.csv' ë¶ˆëŸ¬ì˜¤ê¸°
# 2. ë°ì´í„° í˜•ì‹ ë³€í™˜ ë° ê²€ì¦
#    - fever_focus: integer (0/1)
#    - disease_1/2/3: character
# 3. ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•©
# 4. Inclusion/Exclusion ê¸°ì¤€ ì ìš© (85ì„¸ ì´ìƒ, CT ì‹œí–‰)
# 5. íŒŒìƒ ë³€ìˆ˜ ìƒì„±
# 6. ìµœì¢… ë°ì´í„°ì…‹ ìƒì„± ë° ì €ì¥
# 
# í•„ìš” ì…ë ¥ íŒŒì¼:
#   - ct_analyzed.csv (ì™¸ë¶€ ë¶„ì„ ì™„ë£Œ íŒŒì¼)
#   - cleaned_data/part2_base_typed.rds
#   - cleaned_data/part2_fever_lab_wide.rds
#   - cleaned_data/part2_fever_vitals_summary.rds
#
# ì˜ˆìƒ ì‚°ì¶œë¬¼:
#   - cleaned_data/ct_summary_final.rds
#   - cleaned_data/base_analysis.rds (í™œë ¥ì§•í›„ + CT ë¶„ì„ í¬í•¨)
#==============================================================================