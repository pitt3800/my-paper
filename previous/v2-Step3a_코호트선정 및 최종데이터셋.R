# =============================================================================
# Step 3a: CT ë°ì´í„° ì¤€ë¹„ ë° ì™¸ë¶€ ë¶„ì„ìš© ë‚´ë³´ë‚´ê¸°
# =============================================================================
# ì—°êµ¬: 85ì„¸ ì´ìƒ ë°œì—´ í™˜ì CT ì§„ë‹¨ ê°€ì¹˜ ì—°êµ¬
# ëª©ì : CT ì†Œê²¬ ë°ì´í„° ë‚´ë³´ë‚´ê¸° â†’ ì™¸ë¶€ ë¶„ì„ â†’ ì¬ë¶ˆëŸ¬ì˜¤ê¸° ì¤€ë¹„
# ì˜ˆìƒ ì†Œìš”: 2-3ë¶„
# =============================================================================

#------------------------------------------------------------------------------
# 0. í™˜ê²½ ì„¤ì •
#------------------------------------------------------------------------------
library(tidyverse)
library(readxl)

setwd("/Users/youjinlee/Library/Mobile Documents/com~apple~CloudDocs/My R/Fever c claude")

cat("\n")
cat("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
cat("  Step 3a: CT ë°ì´í„° ì¤€ë¹„ ë° ì™¸ë¶€ ë¶„ì„                      \n")
cat("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")

# Part 2 ê²°ê³¼ë¬¼ ë¡œë“œ
cat("=== Part 2 ê²°ê³¼ë¬¼ ë¡œë“œ ===\n")
base_dedup <- readRDS("cleaned_data/part2_base_typed.rds")
ct_summary_dedup <- readRDS("cleaned_data/part2_ct_summary.rds")

cat(sprintf("âœ“ Base: %dëª…\n", nrow(base_dedup)))
cat(sprintf("âœ“ CT Summary: %dê±´\n\n", nrow(ct_summary_dedup)))

#------------------------------------------------------------------------------
# 1. CT ë°ì´í„° ë‚´ë³´ë‚´ê¸° (ì™¸ë¶€ ë¶„ì„ìš©)
#------------------------------------------------------------------------------
cat("=== STEP 1: CT ë°ì´í„° ë‚´ë³´ë‚´ê¸° ===\n")

# í˜„ì¬ CT summary êµ¬ì¡° í™•ì¸
cat("í˜„ì¬ CT Summary ì—´ êµ¬ì¡°:\n")
cat(paste(" -", names(ct_summary_dedup), collapse = "\n"))
cat("\n\n")

# ì™¸ë¶€ ë¶„ì„ìš© í…œí”Œë¦¿ ìƒì„± (ê¸°ì¡´ ë°ì´í„° + ë¹ˆ ì—´ ì¶”ê°€)
ct_for_analysis <- ct_summary_dedup %>%
  mutate(
    # ìƒˆë¡œ ì¶”ê°€í•  ì—´ë“¤ (ë¹ˆ ê°’ìœ¼ë¡œ ì´ˆê¸°í™”)
    fever_focus = NA_integer_,        # 1 = positive, 0 = negative
    disease_1 = NA_character_,        # ì£¼ìš” ì§ˆí™˜ 1
    disease_2 = NA_character_,        # ì£¼ìš” ì§ˆí™˜ 2  
    disease_3 = NA_character_         # ì£¼ìš” ì§ˆí™˜ 3
  ) %>%
  # ì—´ ìˆœì„œ ì¬ë°°ì¹˜ (ë¶„ì„í•˜ê¸° í¸í•˜ê²Œ)
  select(patient_id, visit_date, n_ct_scans, 
         ct_findings_combined, fever_focus, disease_1, disease_2, disease_3)

# CSV ë‚´ë³´ë‚´ê¸° (UTF-8 with BOM for Excel compatibility)
write_excel_csv(ct_for_analysis, "ct_for_external_analysis.csv")

cat("âœ… CT ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!\n")
cat("   íŒŒì¼ëª…: ct_for_external_analysis.csv\n")
cat(sprintf("   ì´ %dê±´ì˜ CT ê¸°ë¡\n\n", nrow(ct_for_analysis)))


#------------------------------------------------------------------------------
# 5. ì™„ë£Œ í™•ì¸
#------------------------------------------------------------------------------
cat("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
cat("  Step 3a ì™„ë£Œ                                               \n")
cat("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")

cat("âœ… ì™„ë£Œëœ ì‘ì—…:\n")
cat("   1. âœ“ CT ë°ì´í„° ë‚´ë³´ë‚´ê¸° (ct_for_external_analysis.csv)\n")
cat("   2. âœ“ ì™¸ë¶€ ë¶„ì„ ê°€ì´ë“œ ìƒì„± (CT_ë¶„ì„ê°€ì´ë“œ.txt)\n")
cat("   3. âœ“ ìƒ˜í”Œ ë°ì´í„° í™•ì¸\n")
cat("   4. âœ“ ë°ì´í„° í’ˆì§ˆ ì²´í¬\n\n")

cat("ğŸ“ ìƒì„±ëœ íŒŒì¼:\n")
cat("   â€¢ ct_for_external_analysis.csv - ì™¸ë¶€ ë¶„ì„ìš© ë°ì´í„°\n")

cat("ğŸ”„ ë‹¤ìŒ ë‹¨ê³„:\n")
cat("   1. Excelì´ë‚˜ ë‹¤ë¥¸ ë„êµ¬ë¡œ ct_for_external_analysis.csv ì—´ê¸°\n")
cat("   2. CT_ë¶„ì„ê°€ì´ë“œ.txt ì°¸ê³ í•˜ì—¬ ë°ì´í„° ë¶„ì„\n")
cat("   3. fever_focus, disease_1, disease_2, disease_3 ì—´ ì±„ìš°ê¸°\n")
cat("   4. 'ct_analyzed.csv'ë¡œ ì €ì¥ (ê°™ì€ í´ë”)\n")
cat("   5. Step 3b ì‹¤í–‰\n\n")

cat("âš ï¸  ì¤‘ìš” ì•ˆë‚´:\n")
cat("   â€¢ ì™¸ë¶€ ë¶„ì„ ì™„ë£Œ ì „ê¹Œì§€ Step 3bë¥¼ ì‹¤í–‰í•˜ì§€ ë§ˆì„¸ìš”!\n")
cat("   â€¢ íŒŒì¼ëª…ê³¼ ì—´ ì´ë¦„ì„ ì •í™•íˆ ì§€ì¼œì£¼ì„¸ìš”!\n")
cat("   â€¢ patient_idì™€ visit_dateëŠ” ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”!\n\n")

#==============================================================================
# ë‹¤ìŒ ë‹¨ê³„ (Step 3b)
#==============================================================================
# Step 3bì—ì„œ ìˆ˜í–‰í•  ì‘ì—…:
# 
# 1. ì™¸ë¶€ì—ì„œ ë¶„ì„ ì™„ë£Œëœ 'ct_analyzed.csv' ë¶ˆëŸ¬ì˜¤ê¸°
# 2. ë°ì´í„° í˜•ì‹ ë³€í™˜ ë° ê²€ì¦
#    - fever_focus: integer (0/1)
#    - disease_1/2/3: character
# 3. ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•©
# 4. Inclusion/Exclusion ê¸°ì¤€ ì ìš© (85ì„¸ ì´ìƒ, CT ì‹œí–‰)
# 5. íŒŒìƒ ë³€ìˆ˜ ìƒì„±
# 6. ìµœì¢… ë°ì´í„°ì…‹ ìƒì„± ë° ì €ì¥
# 
# í•„ìš” ì…ë ¥ íŒŒì¼:
#   - ct_analyzed.csv (ì™¸ë¶€ ë¶„ì„ ì™„ë£Œ íŒŒì¼)
#   - cleaned_data/part2_base_typed.rds
#   - cleaned_data/part2_fever_lab_wide.rds
#   - cleaned_data/part2_fever_vitals_summary.rds
#
# ì˜ˆìƒ ì‚°ì¶œë¬¼:
#   - cleaned_data/ct_summary_final.rds
#   - cleaned_data/base_analysis.rds (í™œë ¥ì§•í›„ + CT ë¶„ì„ í¬í•¨)
#==============================================================================