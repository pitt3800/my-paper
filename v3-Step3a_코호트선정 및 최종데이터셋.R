# =============================================================================
# v3-Step 3a: CT ë°ì´í„° ì¤€ë¹„ ë° ì™¸ë¶€ ë¶„ì„ìš© ë‚´ë³´ë‚´ê¸° (CSVë²„ì „)
# =============================================================================
# ì—°êµ¬: 85ì„¸ ì´ìƒ ë°œì—´ í™˜ì CT ì§„ë‹¨ ê°€ì¹˜ ì—°êµ¬
# ëª©ì : CT ì†Œê²¬ ë°ì´í„° ë‚´ë³´ë‚´ê¸° â†’ ì™¸ë¶€ ë¶„ì„ â†’ ì¬ë¶ˆëŸ¬ì˜¤ê¸° ì¤€ë¹„
# ì „ì œ: v3-Step2 ì™„ë£Œ (part2_ct_summary.rds ì¡´ì¬)
# ì˜ˆìƒ ì†Œìš”: 2-3ë¶„
# =============================================================================

#------------------------------------------------------------------------------
# 0. í™˜ê²½ ì„¤ì •
#------------------------------------------------------------------------------
library(tidyverse)
library(readxl)

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì • (v3 ë²„ì „ ê²½ë¡œ)
setwd("/Users/youjinlee/Documents/My R/Fever c claude/2017_2025_s")

cat("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
cat("  v3-Step 3a: CT ë°ì´í„° ì¤€ë¹„ ë° ì™¸ë¶€ ë¶„ì„                   \n")
cat("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")

#------------------------------------------------------------------------------
# 1. Step 2 ê²°ê³¼ë¬¼ ë¡œë“œ
#------------------------------------------------------------------------------
cat("=== STEP 1: Step 2 ê²°ê³¼ë¬¼ ë¡œë“œ ===\n")

# Step 2ì—ì„œ ìƒì„±ëœ íŒŒì¼ í™•ì¸
if (!file.exists("cleaned_data/part2_base_typed.rds")) {
  stop("âŒ v3-Step2ë¥¼ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”! (part2_base_typed.rds íŒŒì¼ ì—†ìŒ)")
}

if (!file.exists("cleaned_data/part2_ct_summary.rds")) {
  stop("âŒ v3-Step2ë¥¼ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”! (part2_ct_summary.rds íŒŒì¼ ì—†ìŒ)")
}

base_dedup <- readRDS("cleaned_data/part2_base_typed.rds")
ct_summary_dedup <- readRDS("cleaned_data/part2_ct_summary.rds")

cat(sprintf("âœ“ Base: %dëª…\n", nrow(base_dedup)))
cat(sprintf("âœ“ CT Summary: %dê±´\n\n", nrow(ct_summary_dedup)))

#------------------------------------------------------------------------------
# 2. CT ë°ì´í„° êµ¬ì¡° í™•ì¸
#------------------------------------------------------------------------------
cat("=== STEP 2: CT ë°ì´í„° êµ¬ì¡° í™•ì¸ ===\n")

cat("í˜„ì¬ CT Summary ì—´ êµ¬ì¡°:\n")
ct_cols <- names(ct_summary_dedup)
for(col in ct_cols) {
  cat(sprintf("  - %s\n", col))
}
cat("\n")

# ìƒ˜í”Œ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
cat("ìƒ˜í”Œ ë°ì´í„° (ì²« 3ê±´):\n")
ct_summary_dedup %>%
  dplyr::select(patient_id, exam_date, n_ct_scans, ct_findings_combined) %>%
  head(3) %>%
  print()
cat("\n")

#------------------------------------------------------------------------------
# 3. ì™¸ë¶€ ë¶„ì„ìš© í…œí”Œë¦¿ ìƒì„±
#------------------------------------------------------------------------------
cat("=== STEP 3: ì™¸ë¶€ ë¶„ì„ìš© í…œí”Œë¦¿ ìƒì„± ===\n")

# ì™¸ë¶€ ë¶„ì„ìš© í…œí”Œë¦¿ (ê¸°ì¡´ ë°ì´í„° + ë¹ˆ ì—´ ì¶”ê°€)
ct_for_analysis <- ct_summary_dedup %>%
  dplyr::mutate(
    # ìƒˆë¡œ ì¶”ê°€í•  ì—´ë“¤ (ë¹ˆ ê°’ìœ¼ë¡œ ì´ˆê¸°í™”)
    fever_focus = NA_integer_,        # 1 = positive, 0 = negative
    disease_1 = NA_character_,        # ì£¼ìš” ì§ˆí™˜ 1
    disease_2 = NA_character_,        # ì£¼ìš” ì§ˆí™˜ 2  
    disease_3 = NA_character_         # ì£¼ìš” ì§ˆí™˜ 3
  ) %>%
  # ì—´ ìˆœì„œ ì¬ë°°ì¹˜ (ë¶„ì„í•˜ê¸° í¸í•˜ê²Œ)
  dplyr::select(patient_id, exam_date, n_ct_scans, 
                ct_findings_combined, fever_focus, disease_1, disease_2, disease_3)

cat("âœ“ í…œí”Œë¦¿ ìƒì„± ì™„ë£Œ\n")
cat(sprintf("  - ì´ í–‰ ìˆ˜: %dê±´\n", nrow(ct_for_analysis)))
cat(sprintf("  - ì´ ì—´ ìˆ˜: %dê°œ\n\n", ncol(ct_for_analysis)))

#------------------------------------------------------------------------------
# 4. CSV ë‚´ë³´ë‚´ê¸°
#------------------------------------------------------------------------------
cat("=== STEP 4: CSV ë‚´ë³´ë‚´ê¸° ===\n")

# CSV ë‚´ë³´ë‚´ê¸° (UTF-8 with BOM for Excel compatibility)
write_excel_csv(ct_for_analysis, "ct_for_external_analysis.csv")

cat("âœ… CT ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!\n")
cat("   íŒŒì¼ëª…: ct_for_external_analysis.csv\n")
cat(sprintf("   ì´ %dê±´ì˜ CT ê¸°ë¡\n", nrow(ct_for_analysis)))
cat(sprintf("   ìœ„ì¹˜: %s\n\n", getwd()))

#------------------------------------------------------------------------------
# 5. ë°ì´í„° í’ˆì§ˆ ì²´í¬
#------------------------------------------------------------------------------
cat("=== STEP 5: ë°ì´í„° í’ˆì§ˆ ì²´í¬ ===\n")

# CT findings ê¸¸ì´ í™•ì¸
findings_length <- ct_for_analysis %>%
  dplyr::mutate(finding_length = nchar(ct_findings_combined)) %>%
  dplyr::summarize(
    mean_length = round(mean(finding_length, na.rm = TRUE), 0),
    max_length = max(finding_length, na.rm = TRUE),
    min_length = min(finding_length, na.rm = TRUE)
  )

cat(sprintf("CT ì†Œê²¬ ê¸¸ì´ í†µê³„:\n"))
cat(sprintf("  - í‰ê· : %dì\n", findings_length$mean_length))
cat(sprintf("  - ìµœëŒ€: %dì\n", findings_length$max_length))
cat(sprintf("  - ìµœì†Œ: %dì\n\n", findings_length$min_length))

# í™˜ìë‹¹ CT íšŸìˆ˜ ë¶„í¬
ct_counts <- ct_for_analysis %>%
  dplyr::count(n_ct_scans) %>%
  dplyr::mutate(percentage = round(n / sum(n) * 100, 1)) %>%
  dplyr::arrange(desc(n))

cat("í™˜ìë‹¹ CT ìŠ¤ìº” íšŸìˆ˜ ë¶„í¬:\n")
print(ct_counts)
cat("\n")

#------------------------------------------------------------------------------
# 6. ì™¸ë¶€ ë¶„ì„ ê°€ì´ë“œ ìƒì„±
#------------------------------------------------------------------------------
cat("=== STEP 6: ì™¸ë¶€ ë¶„ì„ ê°€ì´ë“œ ìƒì„± ===\n")

guide_text <- "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  CT ë¶„ì„ ê°€ì´ë“œ (ct_for_external_analysis.csv)
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[1] íŒŒì¼ ì—´ê¸°
   â€¢ Excel ë˜ëŠ” Numbersë¡œ 'ct_for_external_analysis.csv' ì—´ê¸°
   â€¢ í•œê¸€ì´ ê¹¨ì§€ë©´ Excelì—ì„œ 'ë°ì´í„° > í…ìŠ¤íŠ¸ ë‚˜ëˆ„ê¸°' ì‚¬ìš©

[2] ë¶„ì„í•  ì—´ (ì±„ì›Œì•¼ í•  í•­ëª©)
   
   A. fever_focus (í•„ìˆ˜)
      - ë°œì—´ì˜ ì›ì¸ì´ ë  ë§Œí•œ ë³‘ë³€ì´ CTì—ì„œ ë°œê²¬ë˜ì—ˆëŠ”ê°€?
      - ì…ë ¥ê°’: 1 (ì–‘ì„±) ë˜ëŠ” 0 (ìŒì„±)
      - ì˜ˆì‹œ:
        * íë ´ â†’ 1
        * ë³µê°• ë‚´ ë†ì–‘ â†’ 1
        * ìš”ë¡œê°ì—¼ ì†Œê²¬ â†’ 1
        * íŠ¹ì´ ì†Œê²¬ ì—†ìŒ â†’ 0
   
   B. disease_1 (ì„ íƒ)
      - CTì—ì„œ ë°œê²¬ëœ ì£¼ìš” ì§ˆí™˜ 1
      - ì˜ˆì‹œ: 'Pneumonia', 'Abscess', 'Pyelonephritis'
      - ì—†ìœ¼ë©´ ë¹„ì›Œë‘ê¸°
   
   C. disease_2 (ì„ íƒ)
      - CTì—ì„œ ë°œê²¬ëœ ì£¼ìš” ì§ˆí™˜ 2
   
   D. disease_3 (ì„ íƒ)
      - CTì—ì„œ ë°œê²¬ëœ ì£¼ìš” ì§ˆí™˜ 3

[3] ì‘ì—… ìˆœì„œ
   1) ct_findings_combined ì—´ì„ ì½ìœ¼ë©° CT ì†Œê²¬ í™•ì¸
   2) fever_focus ì—´ì— 1 ë˜ëŠ” 0 ì…ë ¥
   3) disease_1, disease_2, disease_3 ì—´ì— ì§ˆí™˜ëª… ì…ë ¥ (ì„ íƒ)
   4) ëª¨ë“  í–‰ ì‘ì—… ì™„ë£Œ í›„ 'ct_analyzed.csv'ë¡œ ì €ì¥
   5) ì €ì¥ ìœ„ì¹˜: ì›ë³¸ íŒŒì¼ê³¼ ê°™ì€ í´ë”

[4] ì£¼ì˜ì‚¬í•­
   âš ï¸  patient_idì™€ exam_dateëŠ” ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”!
   âš ï¸  fever_focusëŠ” ë°˜ë“œì‹œ 0 ë˜ëŠ” 1ë§Œ ì…ë ¥
   âš ï¸  disease ì—´ì€ ë¹„ì›Œë„ ë˜ì§€ë§Œ, ê°€ëŠ¥í•˜ë©´ ì…ë ¥ ê¶Œì¥
   âš ï¸  íŒŒì¼ëª…ì„ ì •í™•íˆ 'ct_analyzed.csv'ë¡œ ì €ì¥

[5] ì™„ë£Œ í›„
   â€¢ v3-Step3b ì½”ë“œ ì‹¤í–‰
   â€¢ ct_analyzed.csvë¥¼ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ ë¶„ì„ ì§„í–‰

â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"

# ê°€ì´ë“œ íŒŒì¼ ì €ì¥
writeLines(guide_text, "CT_ë¶„ì„ê°€ì´ë“œ.txt")

cat("âœ“ ì™¸ë¶€ ë¶„ì„ ê°€ì´ë“œ ì €ì¥: CT_ë¶„ì„ê°€ì´ë“œ.txt\n\n")

#------------------------------------------------------------------------------
# 7. ìƒ˜í”Œ ë°ì´í„° í™•ì¸
#------------------------------------------------------------------------------
cat("=== STEP 7: ìƒ˜í”Œ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° ===\n")

cat("ì²« 3ê±´ ìƒ˜í”Œ (ë¶„ì„ ì˜ˆì‹œ):\n\n")

sample_data <- ct_for_analysis %>%
  head(3) %>%
  dplyr::mutate(
    ct_findings_short = str_trunc(ct_findings_combined, 60)
  ) %>%
  dplyr::select(patient_id, exam_date, ct_findings_short, fever_focus, disease_1)

print(sample_data, width = Inf)
cat("\n")

#------------------------------------------------------------------------------
# 8. Step 3a ì™„ë£Œ í™•ì¸
#------------------------------------------------------------------------------
cat("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
cat("  v3-Step 3a ì™„ë£Œ                                            \n")
cat("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")

cat("âœ… ì™„ë£Œëœ ì‘ì—…:\n")
cat("   1. âœ“ CT ë°ì´í„° ë¡œë“œ ë° êµ¬ì¡° í™•ì¸\n")
cat("   2. âœ“ ì™¸ë¶€ ë¶„ì„ìš© í…œí”Œë¦¿ ìƒì„±\n")
cat("   3. âœ“ CSV ë‚´ë³´ë‚´ê¸° (ct_for_external_analysis.csv)\n")
cat("   4. âœ“ ë°ì´í„° í’ˆì§ˆ ì²´í¬\n")
cat("   5. âœ“ ì™¸ë¶€ ë¶„ì„ ê°€ì´ë“œ ìƒì„± (CT_ë¶„ì„ê°€ì´ë“œ.txt)\n")
cat("   6. âœ“ ìƒ˜í”Œ ë°ì´í„° í™•ì¸\n\n")

cat("ğŸ“ ìƒì„±ëœ íŒŒì¼:\n")
cat("   â€¢ ct_for_external_analysis.csv - ì™¸ë¶€ ë¶„ì„ìš© ë°ì´í„°\n")
cat("   â€¢ CT_ë¶„ì„ê°€ì´ë“œ.txt - ë¶„ì„ ë°©ë²• ì•ˆë‚´\n\n")

cat("ğŸ”„ ë‹¤ìŒ ë‹¨ê³„:\n")
cat("   1. Excelì´ë‚˜ Numbersë¡œ ct_for_external_analysis.csv ì—´ê¸°\n")
cat("   2. CT_ë¶„ì„ê°€ì´ë“œ.txt ì°¸ê³ í•˜ì—¬ ë°ì´í„° ë¶„ì„\n")
cat("   3. fever_focus, disease_1, disease_2, disease_3 ì—´ ì±„ìš°ê¸°\n")
cat("   4. 'ct_analyzed.csv'ë¡œ ì €ì¥ (ê°™ì€ í´ë”)\n")
cat("   5. v3-Step3b ì½”ë“œ ì‹¤í–‰\n\n")

cat("âš ï¸  ì¤‘ìš” ì•ˆë‚´:\n")
cat("   â€¢ ì™¸ë¶€ ë¶„ì„ ì™„ë£Œ ì „ê¹Œì§€ v3-Step3bë¥¼ ì‹¤í–‰í•˜ì§€ ë§ˆì„¸ìš”!\n")
cat("   â€¢ íŒŒì¼ëª…ê³¼ ì—´ ì´ë¦„ì„ ì •í™•íˆ ì§€ì¼œì£¼ì„¸ìš”!\n")
cat("   â€¢ patient_idì™€ exam_dateëŠ” ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”!\n\n")

cat("ğŸ’¡ Tip:\n")
cat(sprintf("   â€¢ ë¶„ì„í•  CT: %dê±´\n", nrow(ct_for_analysis)))
cat("   â€¢ ì‘ì—… ì˜ˆìƒ ì‹œê°„: 30-60ë¶„ (ê±´ìˆ˜ì— ë”°ë¼ ë‹¤ë¦„)\n")
cat("   â€¢ ë¶ˆí™•ì‹¤í•œ ê²½ìš° fever_focus=0ìœ¼ë¡œ ë³´ìˆ˜ì  íŒë‹¨ ê¶Œì¥\n\n")

# ì„¸ì…˜ ì •ë³´ ì €ì¥
writeLines(capture.output(sessionInfo()), "reports/03a_session_info_step3a.txt")

cat("âœ… v3-Step 3a ì™„ë£Œ! ì™¸ë¶€ ë¶„ì„ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.\n\n")

#==============================================================================
# ë‹¤ìŒ ë‹¨ê³„ (v3-Step 3b)
#==============================================================================
# v3-Step3bì—ì„œ ìˆ˜í–‰í•  ì‘ì—…:
# 
# 1. ì™¸ë¶€ì—ì„œ ë¶„ì„ ì™„ë£Œëœ 'ct_analyzed.csv' ë¶ˆëŸ¬ì˜¤ê¸°
# 2. ë°ì´í„° í˜•ì‹ ë³€í™˜ ë° ê²€ì¦
#    - fever_focus: integer (0/1)
#    - disease_1/2/3: character
# 3. ê¸°ì¡´ CT ë°ì´í„°ì™€ ë³‘í•©
# 4. Inclusion/Exclusion ê¸°ì¤€ ì ìš© (85ì„¸ ì´ìƒ, CT ì‹œí–‰)
# 5. íŒŒìƒ ë³€ìˆ˜ ìƒì„± (ì—°ë ¹ ê·¸ë£¹, ê³„ì ˆ, COVID ì‹œê¸° ë“±)
# 6. ë°ì´í„° í†µí•© (Base + CT + Lab + Vitals)
# 7. ìµœì¢… ë°ì´í„°ì…‹ ìƒì„± ë° ì €ì¥
# 
# í•„ìš” ì…ë ¥ íŒŒì¼:
#   - ct_analyzed.csv (ì™¸ë¶€ ë¶„ì„ ì™„ë£Œ íŒŒì¼) â­ í•„ìˆ˜!
#   - cleaned_data/part2_base_typed.rds
#   - cleaned_data/part2_fever_lab_wide.rds
#   - cleaned_data/part2_fever_vitals_summary.rds
#
# ì˜ˆìƒ ì‚°ì¶œë¬¼:
#   - cleaned_data/ct_summary_final.rds (CT ë¶„ì„ ìµœì¢…)
#   - cleaned_data/base_analysis.rds (í™œë ¥ì§•í›„ + CT ë¶„ì„ í¬í•¨)
#   - cleaned_data/base_with_lab_vitals.rds (Lab ì™„ì „íŒ)
#   - reports/03b_flowchart.csv
#   - reports/03b_ct_analysis_summary.csv